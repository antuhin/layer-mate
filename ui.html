<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Layer Mate: Career OS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ========================================
       DESIGN SYSTEM & THEME
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Dark Mode Color Palette */
      --bg-primary: #1A1A1A;
      --bg-secondary: #242424;
      --bg-tertiary: #2E2E2E;
      --bg-hover: #383838;
      --bg-active: #404040;

      --text-primary: #FFFFFF;
      --text-secondary: #A8A8A8;
      --text-tertiary: #707070;
      --text-disabled: #4A4A4A;

      --accent-primary: #0D99FF;
      --accent-hover: #0A7FDB;
      --accent-active: #0866B8;
      --accent-glow: rgba(13, 153, 255, 0.2);

      --success: #00D084;
      --success-bg: rgba(0, 208, 132, 0.1);
      --warning: #FFA629;
      --warning-bg: rgba(255, 166, 41, 0.1);
      --error: #FF5C5C;
      --error-bg: rgba(255, 92, 92, 0.1);

      --border-color: #3A3A3A;
      --border-radius: 8px;
      --border-radius-sm: 6px;
      --border-radius-lg: 12px;

      /* Spacing System */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --spacing-2xl: 24px;

      /* Typography */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-size-xs: 10px;
      --font-size-sm: 11px;
      --font-size-base: 13px;
      --font-size-lg: 14px;
      --font-size-xl: 16px;

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px var(--accent-glow);
    }

    body {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 0;
      margin: 0;
      line-height: 1.5;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================
       MAIN CONTAINER (SIDEBAR + CONTENT)
       ======================================== */
    .app-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* ========================================
       SIDEBAR NAVIGATION
       ======================================== */
    .sidebar {
      width: 70px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: var(--spacing-md) 0;
      gap: var(--spacing-xs);
      flex-shrink: 0;
    }

    .tab-button {
      padding: var(--spacing-md) var(--spacing-xs);
      background: transparent;
      border: none;
      border-left: 3px solid transparent;
      color: var(--text-secondary);
      font-family: var(--font-family);
      font-size: var(--font-size-xs);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-align: center;
      position: relative;
    }

    .tab-icon {
      font-size: 24px;
      display: block;
    }

    .tab-label {
      font-size: 9px;
      line-height: 1.2;
      font-weight: 500;
    }

    .tab-button:hover:not(.active) {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.03);
    }

    .tab-button.active {
      background: rgba(13, 153, 255, 0.08);
      color: var(--accent-primary);
      border-left-color: var(--accent-primary);
    }

    .tab-button.active .tab-icon {
      filter: drop-shadow(0 0 8px var(--accent-glow));
    }

    /* ========================================
       CONTENT AREA
       ======================================== */
    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px;
    }

    /* ========================================
       TAB CONTENT VIEWS
       ======================================== */
    .tab-content {
      display: none;
      animation: fadeInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========================================
       ACCESSIBILITY ENHANCEMENTS
       ======================================== */

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--accent-primary);
      color: white;
      padding: 8px 16px;
      text-decoration: none;
      z-index: 100;
    }

    .skip-link:focus {
      top: 0;
    }

    /* Visually Hidden */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
    }

    /* Focus Indicators */
    *:focus-visible {
      outline: 3px solid var(--accent-primary);
      outline-offset: 2px;
    }

    *:focus:not(:focus-visible) {
      outline: none;
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Architect Mode Zones */
    .dropzone-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .dropzone {
      border: 1px dashed var(--border-color);
      background: rgba(255, 255, 255, 0.02);
      border-radius: var(--border-radius);
      padding: 12px;
      position: relative;
      transition: all 0.2s ease;
    }

    .dropzone.active {
      border-color: var(--accent-primary);
      background: rgba(13, 153, 255, 0.05);
    }

    .dropzone.assigned {
      border-color: var(--success);
      background: rgba(0, 208, 132, 0.05);
      border-style: solid;
    }

    .zone-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .zone-status {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 14px;
    }

    .btn-zone {
      width: 100%;
      background: var(--bg-hover);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      font-size: 11px;
      padding: 6px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-zone:hover {
      background: var(--bg-active);
    }

    /* ========================================
       BUTTONS
       ======================================== */
    .btn {
      width: 100%;
      padding: 8px 12px;
      border: none;
      border-radius: var(--border-radius);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary) 0%, #0A7FDB 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(13, 153, 255, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 6px 16px rgba(13, 153, 255, 0.4);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1.5px solid var(--border-color);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-tertiary);
      border-color: var(--text-tertiary);
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .btn.loading {
      pointer-events: none;
    }

    .btn.loading .btn-text {
      opacity: 0;
    }

    .spinner {
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      opacity: 0;
    }

    .btn.loading .spinner {
      opacity: 1;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ========================================
       SECTION COMPONENTS
       ======================================== */
    .section {
      background: var(--bg-secondary);
      border-radius: var(--border-radius-lg);
      padding: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 8px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .section-icon {
      font-size: 24px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-subtitle {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* ========================================
       FORM CONTROLS
       ======================================== */
    .select-input {
      width: 100%;
      padding: var(--spacing-md);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .select-input:hover {
      border-color: var(--accent-primary);
      background: var(--bg-tertiary);
    }

    .select-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(13, 153, 255, 0.1);
    }

    .checkbox-label {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      cursor: pointer;
      padding: var(--spacing-md);
      background: var(--bg-primary);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .checkbox-label:hover {
      border-color: var(--accent-primary);
      background: var(--bg-tertiary);
    }

    .checkbox-input {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-primary);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .checkbox-text {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      line-height: 1.5;
    }

    /* ========================================
       MODULE 1: CLEAN (JUNIOR)
       ======================================== */
    .hero-section {
      text-align: center;
      padding: 6px 0;
      background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%);
      border-radius: var(--border-radius-lg);
      margin-bottom: 6px;
    }

    .hero-icon {
      font-size: 24px;
      margin-bottom: 3px;
      display: block;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-8px);
      }
    }

    .hero-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 2px;
      color: var(--text-primary);
    }

    .hero-subtitle {
      font-size: 10px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .career-badge {
      display: inline-block;
      background: var(--accent-glow);
      color: var(--accent-primary);
      padding: 4px 12px;
      border-radius: 100px;
      font-size: var(--font-size-xs);
      font-weight: 600;
      margin-top: var(--spacing-sm);
      border: 1px solid rgba(13, 153, 255, 0.3);
    }

    /* ========================================
       MODULE 2: TOKENS (SENIOR)
       ======================================== */
    .results-list {
      max-height: 280px;
      overflow-y: auto;
      background: var(--bg-primary);
      border-radius: var(--border-radius);
      padding: var(--spacing-xs);
      margin-top: var(--spacing-md);
      border: 1px solid var(--border-color);
    }

    .results-list::-webkit-scrollbar {
      width: 8px;
    }

    .results-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .results-list::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-sm);
      background: var(--bg-secondary);
      margin-bottom: var(--spacing-xs);
      border: 1px solid var(--border-color);
    }

    .color-swatch {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      flex-shrink: 0;
      border: 1px solid var(--border-color);
    }

    .result-info {
      flex: 1;
      min-width: 0;
    }

    .result-name {
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .result-detail {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* ========================================
       MODULE 3: QA & LINT (LEAD)
       ======================================== */
    .health-score-container {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-xl);
      margin: var(--spacing-lg) 0;
    }

    .health-score {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .score-circle {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(var(--success) 0deg, var(--bg-tertiary) 0deg);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .score-inner {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .score-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }

    .score-label {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .error-category {
      background: var(--bg-primary);
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      border: 1px solid var(--border-color);
    }

    .error-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-xs);
    }

    .error-title {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--text-primary);
    }

    .error-count {
      background: var(--error-bg);
      color: var(--error);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: var(--font-size-xs);
      font-weight: 600;
    }

    .error-items {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .error-items-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      margin-top: var(--spacing-sm);
      max-height: 200px;
      overflow-y: auto;
    }

    .error-items-list::-webkit-scrollbar {
      width: 6px;
    }

    .error-items-list::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }

    .error-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: var(--bg-secondary);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .error-item:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      transform: translateX(2px);
    }

    .error-icon {
      font-size: 14px;
      flex-shrink: 0;
    }

    .error-name {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .error-action {
      color: var(--accent-primary);
      font-size: var(--font-size-sm);
      flex-shrink: 0;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .error-item:hover .error-action {
      opacity: 1;
    }

    /* ========================================
       MODULE 4: HANDOFF (MANAGER)
       ======================================== */
    .status-selector {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin: var(--spacing-lg) 0;
    }

    .status-option {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .status-option:hover {
      border-color: var(--text-tertiary);
      background: var(--bg-secondary);
    }

    .status-option.selected {
      border-color: var(--accent-primary);
      background: var(--accent-glow);
    }

    .status-radio {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-primary);
    }

    .status-label {
      flex: 1;
      font-size: var(--font-size-base);
      font-weight: 500;
      color: var(--text-primary);
    }

    .status-preview {
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      text-align: center;
      margin-top: var(--spacing-lg);
      border: 1px dashed var(--border-color);
    }

    .preview-label {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-pill-preview {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: 8px 16px;
      border-radius: 16px;
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    /* ========================================
       EMPTY STATE
       ======================================== */
    .empty-state {
      text-align: center;
      padding: var(--spacing-2xl) var(--spacing-lg);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .empty-icon {
      font-size: 32px;
      margin-bottom: var(--spacing-sm);
      opacity: 0.5;
      display: block;
    }

    /* ========================================
       TOAST NOTIFICATION
       ======================================== */
    .toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      font-size: var(--font-size-base);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      max-width: 280px;
      border: 1px solid var(--border-color);
    }

    .toast.show {
      bottom: var(--spacing-xl);
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    /* ========================================
       UTILITY CLASSES
       ======================================== */
    .hidden {
      display: none !important;
    }

    .mt-sm {
      margin-top: var(--spacing-sm);
    }

    .mt-md {
      margin-top: var(--spacing-md);
    }

    /* ========================================
       COLLAPSIBLE SECTIONS
       ======================================== */
    details summary {
      list-style: none;
      user-select: none;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details summary:hover {
      background: rgba(255, 255, 255, 0.05) !important;
      border-color: var(--accent-primary) !important;
    }

    details[open] summary span:last-child {
      transform: rotate(180deg);
    }

    details summary span:last-child {
      transition: transform 0.2s ease;
    }

    /* ========================================
       PLUGIN HEADER
       ======================================== */
    .plugin-header {
      position: fixed;
      top: 0;
      left: 70px;
      right: 0;
      height: 48px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--spacing-md);
      z-index: 100;
    }

    .app-container {
      margin-top: 48px;
    }

    .undo-redo-buttons {
      display: flex;
      gap: 4px;
    }

    .header-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-primary);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
    }

    .header-btn:hover:not(:disabled) {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--accent-primary);
    }

    .header-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .settings-btn:hover:not(:disabled) {
      transform: rotate(45deg);
    }

    /* ========================================
       SETTINGS MODAL
       ======================================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border-color);
      animation: scaleUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes scaleUp {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-secondary);
    }

    .modal-header h2 {
      font-size: var(--font-size-xl);
      font-weight: 600;
      margin: 0;
      color: var(--text-primary);
    }

    .modal-close {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--spacing-lg);
      overflow-y: auto;
      flex: 1;
    }

    .modal-body::-webkit-scrollbar {
      width: 8px;
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .settings-section {
      margin-bottom: var(--spacing-xl);
      padding-bottom: var(--spacing-xl);
      border-bottom: 1px solid var(--border-color);
    }

    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .settings-section-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      margin: 0 0 var(--spacing-md) 0;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .settings-toggle {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      cursor: pointer;
      margin-bottom: var(--spacing-sm);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .settings-toggle:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
    }

    .settings-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-primary);
    }

    .settings-toggle span {
      flex: 1;
      font-size: var(--font-size-base);
      color: var(--text-primary);
    }

    .settings-group {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
    }

    .settings-group.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .settings-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
    }

    .settings-label:last-child {
      margin-bottom: 0;
    }

    .settings-label span {
      font-size: var(--spacing-sm);
      color: var(--text-secondary);
    }

    .settings-label input[type="number"] {
      width: 80px;
      padding: 6px 8px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      text-align: center;
    }

    .settings-label input[type="number"]:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(13, 153, 255, 0.1);
    }

    .settings-select {
      flex: 1;
      max-width: 200px;
      padding: 6px 8px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      cursor: pointer;
    }

    .settings-select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(13, 153, 255, 0.1);
    }

    .modal-footer {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: var(--spacing-md);
      background: var(--bg-secondary);
    }

    .modal-footer .btn {
      flex: 1;
    }
  </style>
</head>

<body>
  <!-- Skip Link for Keyboard Users -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Screen Reader Announcements -->
  <div role="status" aria-live="polite" aria-atomic="true" class="visually-hidden" id="sr-announcements"></div>

  <!-- Header with Settings and Undo/Redo -->
  <div class="plugin-header">
    <div class="undo-redo-buttons">
      <button id="undo-btn" class="header-btn" title="Undo (Cmd+Z)" aria-label="Undo" disabled>
        ‚Ü∂
      </button>
      <button id="redo-btn" class="header-btn" title="Redo (Cmd+Shift+Z)" aria-label="Redo" disabled>
        ‚Ü∑
      </button>
    </div>
    <button id="settings-btn" class="header-btn settings-btn" title="Settings" aria-label="Open settings">
      ‚öôÔ∏è
    </button>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal" style="display: none;" role="dialog" aria-labelledby="settings-title"
    aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="settings-title">‚öôÔ∏è Settings</h2>
        <button id="close-settings" class="close-btn" aria-label="Close settings">√ó</button>
      </div>
      <div class="modal-body">
        <form id="settings-form">
          <!-- Achievement Thresholds -->
          <fieldset>
            <legend>üèÜ Achievement Thresholds</legend>
            <div class="form-group">
              <label for="expert-threshold">Expert Level:</label>
              <input type="number" id="expert-threshold" name="expertThreshold" min="50" max="100" value="95">
            </div>
            <div class="form-group">
              <label for="senior-threshold">Senior Level:</label>
              <input type="number" id="senior-threshold" name="seniorThreshold" min="40" max="95" value="85">
            </div>
            <div class="form-group">
              <label for="junior-threshold">Junior Level:</label>
              <input type="number" id="junior-threshold" name="juniorThreshold" min="30" max="85" value="70">
            </div>
          </fieldset>

          <!-- Naming Preferences -->
          <fieldset>
            <legend>üìù Naming Preferences</legend>
            <div class="form-group">
              <label for="default-convention">Default Convention:</label>
              <select id="default-convention" name="defaultConvention">
                <option value="semantic">Semantic</option>
                <option value="descriptive">Descriptive</option>
                <option value="architect">Architect Mode</option>
              </select>
            </div>
            <div class="form-group">
              <label for="default-casing">Default Casing:</label>
              <select id="default-casing" name="defaultCasing">
                <option value="kebab">kebab-case</option>
                <option value="camel">camelCase</option>
                <option value="pascal">PascalCase</option>
                <option value="snake">snake_case</option>
              </select>
            </div>
          </fieldset>

          <!-- Module Defaults -->
          <fieldset>
            <legend>üîß Module Defaults</legend>
            <div class="form-group">
              <label>
                <input type="checkbox" id="auto-track-analytics" name="autoTrackAnalytics" checked>
                Auto-track analytics
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="show-confidence-scores" name="showConfidenceScores" checked>
                Show confidence scores
              </label>
            </div>
          </fieldset>
        </form>
      </div>
      <div class="modal-footer">
        <button id="reset-settings" class="btn btn-secondary">Reset to Defaults</button>
        <button id="save-settings" class="btn btn-primary">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Preview Rename Modal -->
  <div id="preview-modal" class="modal" style="display: none;" role="dialog" aria-labelledby="preview-title"
    aria-modal="true">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 id="preview-title">üëÅÔ∏è Preview Rename Changes</h2>
        <button id="close-preview" class="close-btn" aria-label="Close preview">√ó</button>
      </div>
      <div class="modal-body">
        <div id="preview-list" class="preview-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
          <!-- Populated dynamically -->
        </div>
        <div class="preview-summary"
          style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--border-radius); text-align: center;">
          <strong id="preview-count" style="color: var(--accent-primary);">0</strong> layers will be renamed
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
        <button id="cancel-preview" class="btn btn-secondary">Cancel</button>
        <button id="apply-preview" class="btn btn-primary">Apply Changes</button>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container">
    <!-- ========================================
         SIDEBAR NAVIGATION
         ======================================== -->
    <nav class="sidebar" role="tablist" aria-label="Plugin modules">
      <button class="tab-button active" data-tab="clean" role="tab" aria-selected="true" aria-controls="clean"
        id="tab-clean">
        <span class="tab-icon" aria-hidden="true">‚ö°</span>
        <span class="tab-label">Clean</span>
      </button>
      <button class="tab-button" data-tab="tokens" role="tab" aria-selected="false" aria-controls="tokens"
        id="tab-tokens">
        <span class="tab-icon" aria-hidden="true">üìÅ</span>
        <span class="tab-label">Organize</span>
      </button>
      <button class="tab-button" data-tab="lint" role="tab" aria-selected="false" aria-controls="lint" id="tab-lint">
        <span class="tab-icon" aria-hidden="true">üõ°Ô∏è</span>
        <span class="tab-label">QA & Lint</span>
      </button>
      <button class="tab-button" data-tab="handoff" role="tab" aria-selected="false" aria-controls="handoff"
        id="tab-handoff">
        <span class="tab-icon" aria-hidden="true">üöÄ</span>
        <span class="tab-label">Handoff</span>
      </button>
    </nav>

    <!-- ========================================
         CONTENT WRAPPER
         ======================================== -->
    <div class="content-wrapper">

      <!-- ========================================
       MODULE 1: THE CLEANER (JUNIOR)
       ======================================== -->
      <main id="main-content">
        <div id="clean" class="tab-content active" role="tabpanel" aria-labelledby="tab-clean">
          <div class="hero-section">
            <span class="hero-icon">‚ö°</span>
            <h1 class="hero-title">Auto-Rename Layers</h1>
            <p class="hero-subtitle">
              Enterprise naming with multiple conventions
            </p>
            <span class="career-badge">Junior Level: Speed & Efficiency</span>
          </div>

          <!-- Naming Convention Selector -->
          <!-- STEP 1: Choose Convention (Gestalt: Proximity) -->
          <div class="section"
            style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <span style="font-size: 20px;" aria-hidden="true">üè∑Ô∏è</span>
              <div>
                <h2 style="font-size: 13px; font-weight: 700; margin: 0; color: var(--text-primary);">Naming Convention
                </h2>
                <p style="font-size: 11px; color: var(--text-secondary); margin: 2px 0 0 0;">Choose your team's standard
                </p>
              </div>
            </div>
            <label for="convention-select" class="visually-hidden">Select naming convention</label>
            <select id="convention-select" class="select-input" aria-label="Choose naming convention"
              style="font-size: 13px; padding: 10px 12px;">
              <option value="architect">Architect Mode</option>
              <option value="atomic">Hierarchical</option>
              <option value="slash">Slash Structure</option>
              <option value="bem">BEM Style</option>
            </select>
            <p class="helper-text"
              style="font-size: 10px; color: var(--text-secondary); margin-top: 6px; opacity: 0.7;">
              <strong id="convention-example" style="font-weight: 500;">Example:</strong> <span
                style="font-family: monospace;">Content ‚Üí Item ‚Üí Container ‚Üí Section ‚Üí Block</span>
            </p>
          </div>

          <!-- STEP 2: Smart Filters (Miller's Law: Chunking) -->
          <details open style="margin-top: 16px;">
            <summary
              style="cursor: pointer; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.08); font-size: 11px; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;">
              <span style="opacity: 0.6;">üéØ</span>
              <span>Advanced Filters</span>
              <span style="margin-left: auto; font-size: 9px; opacity: 0.5;">Optional ‚ñº</span>
            </summary>

            <div
              style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.08);">
              <label class="checkbox-label" for="filter-locked"
                style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="filter-locked" class="checkbox-input">
                <span class="checkbox-text" style="font-size: 11px;">Skip locked layers</span>
              </label>

              <label class="checkbox-label" for="filter-hidden"
                style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="filter-hidden" class="checkbox-input">
                <span class="checkbox-text" style="font-size: 11px;">Skip hidden layers</span>
              </label>

              <label class="checkbox-label" for="filter-default" style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="filter-default" class="checkbox-input">
                <span class="checkbox-text" style="font-size: 11px;">Only rename defaults (Frame 1, etc.)</span>
              </label>
            </div>
          </details>

          <!-- ADVANCED RENAMING OPTIONS -->
          <details style="margin-top: 12px;">
            <summary
              style="cursor: pointer; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.08); font-size: 11px; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;">
              <span style="opacity: 0.6;">‚ö°</span>
              <span>Advanced Renaming</span>
              <span style="margin-left: auto; font-size: 9px; opacity: 0.5;">Optional ‚ñº</span>
            </summary>

            <div
              style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.08);">

              <!-- Sequential Numbering -->
              <div style="margin-bottom: 12px;">
                <label
                  style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-primary); margin-bottom: 8px;">
                  <input type="checkbox" id="enable-sequential" style="margin: 0;">
                  <span>Sequential Numbering</span>
                </label>
                <div id="sequential-controls" style="margin-left: 20px; display: none;">
                  <div style="display: flex; gap: 8px; margin-bottom: 6px;">
                    <label style="flex: 1; font-size: 10px; color: var(--text-secondary);">
                      Start:
                      <input type="number" id="seq-start" value="1" min="0"
                        style="width: 100%; padding: 4px 6px; margin-top: 2px; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); font-size: 10px;">
                    </label>
                    <label style="flex: 1; font-size: 10px; color: var(--text-secondary);">
                      Padding:
                      <select id="seq-padding"
                        style="width: 100%; padding: 4px 6px; margin-top: 2px; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); font-size: 10px;">
                        <option value="0">None (1, 2, 3)</option>
                        <option value="2" selected>2 digits (01, 02)</option>
                        <option value="3">3 digits (001, 002)</option>
                      </select>
                    </label>
                  </div>
                  <label style="font-size: 10px; color: var(--text-secondary);">
                    Position:
                    <select id="seq-position"
                      style="width: 100%; padding: 4px 6px; margin-top: 2px; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); font-size: 10px;">
                      <option value="suffix">Suffix (name-01)</option>
                      <option value="prefix">Prefix (01-name)</option>
                    </select>
                  </label>
                </div>
              </div>

              <!-- Find & Replace -->
              <div style="margin-bottom: 12px;">
                <label
                  style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-primary); margin-bottom: 8px;">
                  <input type="checkbox" id="enable-find-replace" style="margin: 0;">
                  <span>Find & Replace</span>
                </label>
                <div id="find-replace-controls" style="margin-left: 20px; display: none;">
                  <input type="text" id="find-text" placeholder="Find..."
                    style="width: 100%; padding: 6px 8px; margin-bottom: 6px; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); font-size: 10px;">
                  <input type="text" id="replace-text" placeholder="Replace with..."
                    style="width: 100%; padding: 6px 8px; margin-bottom: 6px; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); font-size: 10px;">
                  <label
                    style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-secondary);">
                    <input type="checkbox" id="case-sensitive" style="margin: 0;">
                    <span>Case sensitive</span>
                  </label>
                </div>
              </div>

              <!-- Prefix/Suffix -->
              <div style="margin-bottom: 12px;">
                <label
                  style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-primary); margin-bottom: 8px;">
                  <input type="checkbox" id="enable-prefix-suffix" style="margin: 0;">
                  <span>Add Prefix/Suffix</span>
                </label>
                <div id="prefix-suffix-controls" style="margin-left: 20px; display: none;">
                  <input type="text" id="prefix-text" placeholder="Prefix..."
                    style="width: 100%; padding: 6px 8px; margin-bottom: 6px; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); font-size: 10px;">
                  <input type="text" id="suffix-text" placeholder="Suffix..."
                    style="width: 100%; padding: 6px 8px; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); font-size: 10px;">
                </div>
              </div>

              <!-- Quick Presets -->
              <div style="border-top: 1px solid rgba(255,255,255,0.08); padding-top: 12px;">
                <p style="font-size: 10px; color: var(--text-secondary); margin-bottom: 8px;">Quick Presets:</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                  <button class="preset-btn btn btn-secondary" data-preset="clean-defaults"
                    style="padding: 6px 8px; font-size: 10px; justify-content: center;">
                    Clean Defaults
                  </button>
                  <button class="preset-btn btn btn-secondary" data-preset="remove-numbers"
                    style="padding: 6px 8px; font-size: 10px; justify-content: center;">
                    Remove Numbers
                  </button>
                  <button class="preset-btn btn btn-secondary" data-preset="capitalize"
                    style="padding: 6px 8px; font-size: 10px; justify-content: center;">
                    Capitalize
                  </button>
                  <button class="preset-btn btn btn-secondary" data-preset="lowercase"
                    style="padding: 6px 8px; font-size: 10px; justify-content: center;">
                    Lowercase
                  </button>
                </div>
              </div>

              <!-- Action Buttons -->
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button id="preview-rename-btn" class="btn btn-secondary"
                  style="flex: 1; padding: 8px 12px; font-size: 11px; justify-content: center;">
                  üëÅÔ∏è Preview
                </button>
                <button id="apply-rename-btn" class="btn btn-primary"
                  style="flex: 1; padding: 8px 12px; font-size: 11px; justify-content: center;">
                  ‚ö° Apply
                </button>
              </div>
            </div>
          </details>


          <!-- Von Restorff Effect: Isolate Primary Action -->
          <div
            style="margin-top: 24px; padding: 20px 0; border-top: 2px solid rgba(255,255,255,0.05); border-bottom: 2px solid rgba(255,255,255,0.05);">
            <!-- Fitts's Law: Large, Easy Target -->
            <button id="auto-rename-btn" class="btn btn-primary"
              style="width: 100%; padding: 16px 20px; font-size: 15px; font-weight: 700; box-shadow: 0 8px 24px rgba(13, 153, 255, 0.4), 0 0 0 3px rgba(13, 153, 255, 0.1); border-radius: 10px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);"
              aria-label="Auto-rename selected layers using chosen convention"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 32px rgba(13, 153, 255, 0.5), 0 0 0 3px rgba(13, 153, 255, 0.15)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(13, 153, 255, 0.4), 0 0 0 3px rgba(13, 153, 255, 0.1)';">
              <span class="btn-text" aria-hidden="true" style="font-size: 18px;">‚ú®</span>
              <span class="btn-text" style="letter-spacing: 0.3px;">Auto-Rename Selection</span>
              <span class="spinner" role="status" aria-label="Loading"></span>
            </button>
            <p
              style="text-align: center; font-size: 10px; color: var(--text-secondary); margin-top: 8px; opacity: 0.6;">
              Applies kebab-case naming to selected layers</p>
          </div>

          <!-- Gestalt: Group Secondary Actions -->
          <details open style="margin-top: 12px;">
            <summary
              style="cursor: pointer; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.08); font-size: 11px; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;">
              <span style="opacity: 0.6;">‚öôÔ∏è</span>
              <span>Cleanup Utilities</span>
              <span style="margin-left: auto; font-size: 9px; opacity: 0.5;">Optional ‚ñº</span>
            </summary>


            <div
              style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.08);">
              <p style="font-size: 10px; color: var(--text-secondary); margin-bottom: 10px; opacity: 0.7;">Quick cleanup
                actions for your layers</p>

              <button id="remove-hidden-btn" class="btn btn-secondary"
                style="width: 100%; padding: 9px 12px; font-size: 11px; margin-bottom: 6px; justify-content: flex-start;">
                <span class="btn-text" aria-hidden="true" style="margin-right: 8px;">üóëÔ∏è</span>
                <span class="btn-text">Remove Hidden Layers</span>
                <span class="spinner" role="status" aria-label="Loading"></span>
              </button>

              <button id="remove-redundant-btn" class="btn btn-secondary"
                style="width: 100%; padding: 9px 12px; font-size: 11px; justify-content: flex-start;">
                <span class="btn-text" aria-hidden="true" style="margin-right: 8px;">üì¶</span>
                <span class="btn-text">Flatten Redundant Wrappers</span>
                <span class="spinner" role="status" aria-label="Loading"></span>
              </button>
            </div>
          </details>
        </div>
      </main>

      <!-- ========================================
       MODULE 2: THE ORGANIZER (SENIOR)
       ======================================== -->
      <div id="tokens" class="tab-content">
        <div class="hero-section">
          <span class="hero-icon">üìÅ</span>
          <h1 class="hero-title">Smart Organizer</h1>
          <p class="hero-subtitle">
            Group components with slash notation
          </p>
          <span class="career-badge">Senior Level: System Thinking</span>
        </div>
        <!-- Mode Toggle -->
        <div class="section">
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary active" id="mode-grouping" style="flex: 1;">
              <span class="btn-text">üìÅ Grouping</span>
            </button>
            <button class="btn btn-secondary" id="mode-layout-btn" style="flex: 1;">
              <span class="btn-text">üèóÔ∏è Structure</span>
            </button>
            <button class="btn btn-secondary" id="mode-colors" style="flex: 1; opacity: 0.6;">
              <span class="btn-text">üé® Colors</span>
            </button>
          </div>
        </div>

        <!-- Smart Grouping Mode -->
        <div id="grouping-mode">
          <div class="section" style="background: var(--bg-primary); border: 1px dashed var(--border-color);">
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
              <strong style="color: var(--text-primary);">How it works:</strong><br>
              Select layers with common prefixes:<br>
              ‚Ä¢ Button Primary, Button Secondary<br>
              ‚Ä¢ Card Product, Card User<br>
              <br>
              They'll be renamed to:<br>
              ‚Ä¢ Button / Primary, Button / Secondary<br>
              ‚Ä¢ Card / Product, Card / User
            </div>
          </div>

          <button id="smart-grouping-btn" class="btn btn-primary">
            <span class="btn-text">üìÅ Group by Prefix</span>
            <span class="spinner"></span>
          </button>
        </div>

        <!-- Architect Layout Mode -->
        <div id="layout-mode" class="hidden">
          <div class="dropzone-container">
            <div class="dropzone" id="zone-header">
              <div class="zone-label">Header Zone</div>
              <button class="btn-zone" id="set-header-btn">Set Selected as Header</button>
              <div class="zone-status hidden" id="status-header">‚úÖ</div>
            </div>
            <div class="dropzone" id="zone-body">
              <div class="zone-label">Body / Main Zone</div>
              <button class="btn-zone" id="set-body-btn">Set Selected as Body</button>
              <div class="zone-status hidden" id="status-body">‚úÖ</div>
            </div>
            <div class="dropzone" id="zone-footer">
              <div class="zone-label">Footer Zone</div>
              <button class="btn-zone" id="set-footer-btn">Set Selected as Footer</button>
              <div class="zone-status hidden" id="status-footer">‚úÖ</div>
            </div>
          </div>

          <button id="auto-structure-btn" class="btn btn-primary" disabled>
            <span class="btn-text">üèóÔ∏è Auto-Structure Body</span>
            <span class="spinner"></span>
          </button>
        </div>

        <!-- Detached Colors Mode -->
        <div id="colors-mode" class="hidden">
          <button id="scan-colors-btn" class="btn btn-primary">
            <span class="btn-text">üîç Scan for Detached Styles</span>
            <span class="spinner"></span>
          </button>

          <div id="colors-results" class="results-list hidden">
            <!-- Results will be populated here -->
          </div>

          <div id="colors-empty" class="empty-state">
            <span class="empty-icon">‚úÖ</span>
            <div>Click "Scan" to check for detached colors</div>
          </div>
        </div>
      </div>

      <!-- ========================================
       MODULE 3: THE LINTER (LEAD)
       ======================================== -->
      <div id="lint" class="tab-content">
        <div class="hero-section">
          <span class="hero-icon">üõ°Ô∏è</span>
          <h1 class="hero-title">Quality Audit</h1>
          <p class="hero-subtitle">
            Run comprehensive quality checks on your design
          </p>
          <span class="career-badge">Lead Level: Quality Control</span>
        </div>
        <button id="audit-btn" class="btn btn-primary">
          <span class="btn-text">üîç Run Quality Check</span>
          <span class="spinner"></span>
        </button>

        <div id="audit-results" class="hidden">
          <div class="health-score-container">
            <div class="health-score">
              <div class="score-circle" id="score-circle">
                <div class="score-inner">
                  <div class="score-value" id="score-value">--</div>
                  <div class="score-label">Health Score</div>
                </div>
              </div>
            </div>
          </div>

          <div id="error-list">
            <!-- Error categories will be populated here -->
          </div>
        </div>

        <div id="audit-empty" class="empty-state">
          <span class="empty-icon">üìã</span>
          <div>Click "Run Quality Check" to audit your selection</div>
        </div>
      </div>

      <!-- ========================================
       MODULE 4: THE HANDOFF MANAGER (MANAGER)
       ======================================== -->
      <div id="handoff" class="tab-content">
        <div class="hero-section">
          <span class="hero-icon">üöÄ</span>
          <h1 class="hero-title">Set Frame Status</h1>
          <p class="hero-subtitle">
            Add visual status indicators for dev handoff
          </p>
          <span class="career-badge">Manager Level: Process & Scale</span>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-icon">üè∑Ô∏è</span>
            <div>
              <h2 class="section-title">Choose Status</h2>
              <p class="section-subtitle">Select the design readiness level</p>
            </div>
          </div>

          <div class="status-selector">
            <label class="status-option selected" data-status="draft">
              <input type="radio" name="status" value="draft" class="status-radio" checked>
              <span class="status-label">üî¥ Draft</span>
            </label>

            <label class="status-option" data-status="review">
              <input type="radio" name="status" value="review" class="status-radio">
              <span class="status-label">üü° In Review</span>
            </label>

            <label class="status-option" data-status="ready">
              <input type="radio" name="status" value="ready" class="status-radio">
              <span class="status-label">üü¢ Ready for Dev</span>
            </label>
          </div>

          <div class="status-preview">
            <div class="preview-label">Preview</div>
            <div class="status-pill-preview" id="pill-preview"
              style="background: rgba(255, 92, 92, 0.15); color: #FF5C5C; border: 1.5px solid #FF5C5C;">
              üî¥ Draft
            </div>
          </div>
        </div>

        <button id="apply-status-btn" class="btn btn-primary">
          <span class="btn-text">Apply Status Pill</span>
          <span class="spinner"></span>
        </button>
      </div>

      <!-- ========================================
       TOAST NOTIFICATION
       ======================================== -->
      <div id="toast" class="toast">
        <span class="toast-icon">‚ú®</span>
        <span id="toast-message" class="toast-content">Success!</span>
      </div>

      <!-- ========================================
       UI LOGIC (VANILLA JAVASCRIPT)
       ======================================== -->
      <script>
        // ========================================
        // STATE MANAGEMENT
        // ========================================
        let currentTab = 'clean';
        let currentCasing = 'kebab'; // Default to kebab-case
        let currentStatus = 'draft';
        let toastTimeout = null;

        // ========================================
        // ACCESSIBILITY & UX ENHANCEMENTS
        // ========================================

        // Screen Reader Announcements
        function announceToScreenReader(message) {
          const srAnnouncements = document.getElementById('sr-announcements');
          if (srAnnouncements) {
            srAnnouncements.textContent = message;
            setTimeout(() => {
              srAnnouncements.textContent = '';
            }, 1000);
          }
        }

        // Advanced Options (Always Visible - No Toggle Needed)

        // Convention Example Updater
        const conventionSelect = document.getElementById('convention-select');
        const conventionExample = document.getElementById('convention-example');
        const architectStructure = document.getElementById('architect-structure');

        const examples = {
          'atomic': 'Content ‚Üí Item ‚Üí Container ‚Üí Section ‚Üí Block',
          'slash': 'button / primary',
          'bem': 'button__primary',
          'architect': 'section.[name] + card-item/list-item/grid-item'
        };

        conventionSelect.addEventListener('change', () => {
          const selectedConvention = conventionSelect.value;
          const example = examples[selectedConvention] || examples['atomic'];
          const exampleSpan = conventionExample.nextElementSibling;
          if (exampleSpan) {
            exampleSpan.textContent = example;
          }

          // Show/hide Architect Structure UI
          if (selectedConvention === 'architect') {
            architectStructure.classList.remove('hidden');
          } else {
            architectStructure.classList.add('hidden');
          }
        });

        // ========================================
        // AUTO-RESIZE WINDOW TO FIT CONTENT
        // ========================================
        function resizeToFitContent() {
          const contentHeight = document.body.scrollHeight;
          parent.postMessage({
            pluginMessage: {
              type: 'resize-window',
              height: contentHeight + 20
            }
          }, '*');
        }

        // Resize on load
        setTimeout(resizeToFitContent, 100);

        // Resize when details sections expand/collapse
        document.querySelectorAll('details').forEach(details => {
          details.addEventListener('toggle', () => {
            setTimeout(resizeToFitContent, 50);
          });
        });

        // ========================================
        // TAB SWITCHING LOGIC
        // ========================================
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;

            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(targetTab).classList.add('active');

            currentTab = targetTab;
            parent.postMessage({
              pluginMessage: {
                type: 'save-tab',
                tab: targetTab
              }
            }, '*');
          });
        });

        // ========================================
        // MODULE 1: CLEAN - AUTO RENAME
        // ========================================
        const autoRenameBtn = document.getElementById('auto-rename-btn');


        autoRenameBtn.addEventListener('click', () => {
          setButtonLoading(autoRenameBtn, true);

          // Collect filter settings
          const filters = {
            skipLocked: document.getElementById('filter-locked')?.checked || false,
            skipHidden: document.getElementById('filter-hidden')?.checked || false,
            onlyDefaultNames: document.getElementById('filter-default')?.checked || false
          };

          parent.postMessage({
            pluginMessage: {
              type: 'auto-rename',
              casing: currentCasing,
              convention: conventionSelect.value,
              filters: filters
            }
          }, '*');
        });


        // Remove Hidden Layers action
        const removeHiddenBtn = document.getElementById('remove-hidden-btn');
        if (removeHiddenBtn) {
          removeHiddenBtn.addEventListener('click', () => {
            setButtonLoading(removeHiddenBtn, true);
            parent.postMessage({
              pluginMessage: {
                type: 'remove-hidden-layers'
              }
            }, '*');
          });
        }

        // Remove Redundant Wrappers action
        const removeRedundantBtn = document.getElementById('remove-redundant-btn');
        if (removeRedundantBtn) {
          removeRedundantBtn.addEventListener('click', () => {
            setButtonLoading(removeRedundantBtn, true);
            parent.postMessage({
              pluginMessage: {
                type: 'remove-redundant-wrappers'
              }
            }, '*');
          });
        }

        // ========================================
        // MODULE 2: ORGANIZER - MODE TOGGLE & ACTIONS
        // ========================================
        const modeGroupingBtn = document.getElementById('mode-grouping');
        const modeLayoutBtn = document.getElementById('mode-layout-btn');
        const modeColorsBtn = document.getElementById('mode-colors');

        const groupingMode = document.getElementById('grouping-mode');
        const layoutMode = document.getElementById('layout-mode');
        const colorsMode = document.getElementById('colors-mode');

        const smartGroupingBtn = document.getElementById('smart-grouping-btn');
        const scanColorsBtn = document.getElementById('scan-colors-btn');

        // Toggle Function
        function setOrganizerMode(mode) {
          [groupingMode, layoutMode, colorsMode].forEach(el => el && el.classList.add('hidden'));
          [modeGroupingBtn, modeLayoutBtn, modeColorsBtn].forEach(btn => btn && (btn.style.opacity = '0.6'));

          if (mode === 'grouping') {
            groupingMode.classList.remove('hidden');
            modeGroupingBtn.style.opacity = '1';
          } else if (mode === 'layout') {
            layoutMode.classList.remove('hidden');
            modeLayoutBtn.style.opacity = '1';
          } else if (mode === 'colors') {
            colorsMode.classList.remove('hidden');
            modeColorsBtn.style.opacity = '1';
          }
        }

        modeGroupingBtn.addEventListener('click', () => setOrganizerMode('grouping'));
        modeLayoutBtn.addEventListener('click', () => setOrganizerMode('layout'));
        modeColorsBtn.addEventListener('click', () => setOrganizerMode('colors'));

        // Smart Grouping Action
        smartGroupingBtn.addEventListener('click', () => {
          setButtonLoading(smartGroupingBtn, true);
          parent.postMessage({ pluginMessage: { type: 'smart-grouping' } }, '*');
        });

        // Detached Colors Action
        scanColorsBtn.addEventListener('click', () => {
          setButtonLoading(scanColorsBtn, true);
          parent.postMessage({ pluginMessage: { type: 'find-detached-colors' } }, '*');
        });

        // ========================================
        // ARCHITECT MODE: DESIGN OS MODULES
        // ========================================

        // Module 1: Generate Page Shell
        const generateShellBtn = document.getElementById('generate-shell-btn');
        if (generateShellBtn) {
          generateShellBtn.addEventListener('click', () => {
            setButtonLoading(generateShellBtn, true);
            parent.postMessage({
              pluginMessage: {
                type: 'generate-page-shell'
              }
            }, '*');
          });
        }

        // Module 2: Auto-Structure Content
        const autoStructureBtn = document.getElementById('auto-structure-btn');
        if (autoStructureBtn) {
          autoStructureBtn.addEventListener('click', () => {
            setButtonLoading(autoStructureBtn, true);
            parent.postMessage({
              pluginMessage: {
                type: 'auto-structure'
              }
            }, '*');
          });
        }

        // Module 3: Visual Overlay Toggle
        const visualOverlayToggle = document.getElementById('visual-overlay-toggle');
        if (visualOverlayToggle) {
          visualOverlayToggle.addEventListener('change', () => {
            parent.postMessage({
              pluginMessage: {
                type: 'toggle-visual-overlay',
                enabled: visualOverlayToggle.checked
              }
            }, '*');
          });
        }

        // ========================================
        // ARCHITECT MODE: LEGACY HANDLERS (Remove these)
        // ========================================
        // Architect Layout Actions
        const setHeaderBtn = document.getElementById('set-header-btn');
        const setBodyBtn = document.getElementById('set-body-btn');
        const setFooterBtn = document.getElementById('set-footer-btn');

        setHeaderBtn.addEventListener('click', () => {
          parent.postMessage({ pluginMessage: { type: 'assign-region', region: 'header' } }, '*');
        });
        setBodyBtn.addEventListener('click', () => {
          parent.postMessage({ pluginMessage: { type: 'assign-region', region: 'body' } }, '*');
        });
        setFooterBtn.addEventListener('click', () => {
          parent.postMessage({ pluginMessage: { type: 'assign-region', region: 'footer' } }, '*');
        });
        // The autoStructureBtn was moved above, so this listener is removed.
        // autoStructureBtn.addEventListener('click', () => {
        //   setButtonLoading(autoStructureBtn, true);
        //   parent.postMessage({ pluginMessage: { type: 'auto-structure' } }, '*');
        // });

        // ========================================
        // MODULE 3: LINT - QUALITY AUDIT
        // ========================================
        const auditBtn = document.getElementById('audit-btn');
        auditBtn.addEventListener('click', () => {
          setButtonLoading(auditBtn, true);
          parent.postMessage({
            pluginMessage: {
              type: 'quality-audit'
            }
          }, '*');
        });

        // ========================================
        // MODULE 4: HANDOFF - STATUS SELECTION
        // ========================================
        const statusOptions = document.querySelectorAll('.status-option');
        const pillPreview = document.getElementById('pill-preview');

        const statusStyles = {
          draft: {
            text: 'üî¥ Draft',
            bg: 'rgba(255, 92, 92, 0.15)',
            color: '#FF5C5C',
            border: '#FF5C5C'
          },
          review: {
            text: 'üü° In Review',
            bg: 'rgba(255, 166, 41, 0.15)',
            color: '#FFA629',
            border: '#FFA629'
          },
          ready: {
            text: 'üü¢ Ready for Dev',
            bg: 'rgba(0, 208, 132, 0.15)',
            color: '#00D084',
            border: '#00D084'
          }
        };

        statusOptions.forEach(option => {
          option.addEventListener('click', () => {
            const status = option.dataset.status;
            currentStatus = status;

            statusOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');

            // Update preview
            const style = statusStyles[status];
            pillPreview.textContent = style.text;
            pillPreview.style.background = style.bg;
            pillPreview.style.color = style.color;
            pillPreview.style.border = `1.5px solid ${style.border}`;
          });
        });

        // ========================================
        // MODULE 4: HANDOFF - APPLY STATUS
        // ========================================
        const applyStatusBtn = document.getElementById('apply-status-btn');
        applyStatusBtn.addEventListener('click', () => {
          setButtonLoading(applyStatusBtn, true);
          parent.postMessage({
            pluginMessage: {
              type: 'set-frame-status',
              status: currentStatus
            }
          }, '*');
        });

        // ========================================
        // LOADING STATES
        // ========================================
        function setButtonLoading(button, isLoading) {
          if (isLoading) {
            button.classList.add('loading');
            button.disabled = true;
          } else {
            button.classList.remove('loading');
            button.disabled = false;
          }
        }

        // ========================================
        // TOAST NOTIFICATION SYSTEM
        // ========================================
        function showToast(icon, message) {
          const toast = document.getElementById('toast');
          const toastIcon = document.querySelector('.toast-icon');
          const toastMessage = document.getElementById('toast-message');

          toastIcon.textContent = icon;
          toastMessage.textContent = message;
          toast.classList.add('show');

          if (toastTimeout) {
            clearTimeout(toastTimeout);
          }

          toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
          }, 3000);
        }

        // ========================================
        // RENDER FUNCTIONS
        // ========================================
        function renderDetachedColors(data) {
          const resultsContainer = document.getElementById('colors-results');
          const emptyState = document.getElementById('colors-empty');

          if (!data || data.length === 0) {
            resultsContainer.classList.add('hidden');
            emptyState.innerHTML = `
          <span class="empty-icon">‚úÖ</span>
          <div>No detached colors found! Your design system is clean.</div>
        `;
            return;
          }

          emptyState.classList.add('hidden');
          resultsContainer.classList.remove('hidden');

          const html = data.map(item => {
            return item.issues.map(issue => {
              const isType = issue.type === 'typography';
              const displayDetail = isType ? 'Missing Text Style' : `${issue.property}: ${issue.color}`;
              const displaySwatch = isType ?
                `<div class="color-swatch" style="background: var(--bg-secondary); color: var(--text-primary); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 1px solid var(--border-color);">Ag</div>` :
                `<div class="color-swatch" style="background: ${issue.color};"></div>`;

              return `
          <div class="result-item">
            ${displaySwatch}
            <div class="result-info">
              <div class="result-name">${escapeHtml(item.name)}</div>
              <div class="result-detail">${displayDetail}</div>
              ${issue.suggestion ? `
                <div class="suggestion-box" style="margin-top: 6px; padding: 6px 8px; background: rgba(13, 153, 255, 0.08); border-radius: 4px; border-left: 2px solid var(--accent-primary);">
                  <div style="display: flex; align-items: center; gap: 6px; font-size: 11px;">
                    <div class="color-swatch" style="width: 14px; height: 14px; background: ${issue.suggestion.hex};"></div>
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: var(--text-primary);">üí° Suggested: ${escapeHtml(issue.suggestion.name)}</div>
                      <div style="color: var(--text-secondary); font-size: 10px;">${issue.suggestion.similarity}% match</div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
            <button class="locate-btn" data-node-id="${item.id}" title="Locate & Zoom">
              üéØ
            </button>
          </div>
        `;
            }).join('');
          }).join('');

          resultsContainer.innerHTML = html;

          // Add click handlers for locate buttons
          resultsContainer.querySelectorAll('.locate-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const nodeId = btn.getAttribute('data-node-id');
              parent.postMessage({
                pluginMessage: {
                  type: 'locate-node',
                  nodeId: nodeId
                }
              }, '*');
            });
          });
        }

        function renderQualityAudit(healthScore, errors, totalChecks, passedChecks, improvementTips) {
          const resultsContainer = document.getElementById('audit-results');
          const emptyState = document.getElementById('audit-empty');
          const scoreCircle = document.getElementById('score-circle');
          const scoreValue = document.getElementById('score-value');
          const errorList = document.getElementById('error-list');

          emptyState.classList.add('hidden');
          resultsContainer.classList.remove('hidden');

          // Update health score
          scoreValue.textContent = healthScore;
          const degrees = (healthScore / 100) * 360;
          const color = healthScore >= 80 ? '#00D084' : healthScore >= 50 ? '#FFA629' : '#FF5C5C';
          scoreCircle.style.background = `conic - gradient(${color} ${degrees}deg, var(--bg - tertiary) ${degrees}deg)`;

          // Render error categories with clickable items
          let errorHtml = '';

          if (errors.missingAltText.length > 0) {
            errorHtml += `
            < div class="error-category" >
            <div class="error-header">
              <span class="error-title">Missing Alt Text</span>
              <span class="error-count">${errors.missingAltText.length}</span>
            </div>
            <div class="error-items-list">
              ${errors.missingAltText.map(e => `
                <div class="error-item" onclick="locateNode('${e.id}')">
                  <span class="error-icon">üéØ</span>
                  <div style="flex: 1;">
                    <div class="error-name">${escapeHtml(e.name)}</div>
                    ${e.suggestion ? `<div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">üí° ${e.suggestion}</div>` : ''}
                  </div>
                  <span class="error-action">‚Üí</span>
                </div>
              `).join('')}
            </div>
          </div >
            `;
          }

          if (errors.defaultNames.length > 0) {
            errorHtml += `
            < div class="error-category" >
            <div class="error-header">
              <span class="error-title">Default Layer Names</span>
              <span class="error-count">${errors.defaultNames.length}</span>
            </div>
            <div class="error-items-list">
              ${errors.defaultNames.map(e => `
                <div class="error-item" onclick="locateNode('${e.id}')">
                  <span class="error-icon">üéØ</span>
                  <span class="error-name">${escapeHtml(e.name)}</span>
                  <span class="error-action">‚Üí</span>
                </div>
              `).join('')}
            </div>
          </div >
            `;
          }

          if (errors.poorContrast.length > 0) {
            errorHtml += `
            < div class="error-category" >
            <div class="error-header">
              <span class="error-title">Potential Contrast Issues</span>
              <span class="error-count">${errors.poorContrast.length}</span>
            </div>
            <div class="error-items-list">
              ${errors.poorContrast.map(e => `
                <div class="error-item" onclick="locateNode('${e.id}')">
                  <span class="error-icon">üéØ</span>
                  <div style="flex: 1;">
                    <div class="error-name">${escapeHtml(e.name)}</div>
                    ${e.suggestion ? `<div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">üí° ${e.suggestion}</div>` : ''}
                  </div>
                  <span class="error-action">‚Üí</span>
                </div>
              `).join('')}
            </div>
          </div >
            `;
          }

          // Add improvement tips section
          if (improvementTips && improvementTips.length > 0) {
            errorHtml += `
            < div style = "margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--color-primary);" >
              <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">üí° How to Improve Your Health Score</div>
            ${improvementTips.map(tip => `
              <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; padding-left: 8px;">‚Ä¢ ${tip}</div>
            `).join('')
              }
          </div >
            `;
          }

          if (errorHtml === '') {
            errorHtml = `
            < div class="empty-state" >
            <span class="empty-icon">üéâ</span>
            <div>Perfect! No issues found.</div>
          </div >
            `;
          }

          errorList.innerHTML = errorHtml;
        }

        // ========================================
        // LOCATE NODE FUNCTION
        // ========================================
        function locateNode(nodeId) {
          parent.postMessage({
            pluginMessage: {
              type: 'locate-node',
              nodeId: nodeId
            }
          }, '*');
        }

        // ========================================
        // MESSAGE HANDLER FROM BACKEND
        // ========================================
        window.onmessage = (event) => {
          const msg = event.data.pluginMessage;

          switch (msg.type) {
            case 'auto-rename-complete':
              setButtonLoading(autoRenameBtn, false);
              if (msg.stats && Object.values(msg.stats).some(v => v > 0)) {
                const statsText = Object.entries(msg.stats)
                  .filter(([_, count]) => count > 0)
                  .map(([type, count]) => `${count} ${type} `)
                  .join(', ');
                showToast(`‚úÖ Renamed ${msg.count} layers: ${statsText} `, 'success');
              } else {
                showToast(`‚úÖ Renamed ${msg.count} layers successfully!`, 'success');
              }
              break;
          }

          if (msg.type === 'grouping-complete') {
            setButtonLoading(smartGroupingBtn, false);
            const groupText = msg.groups.join(', ');
            showToast('üìÅ', `Grouped ${msg.count} layers into: ${groupText} `);
          }

          if (msg.type === 'hidden-layers-removed') {
            const removeHiddenBtn = document.getElementById('remove-hidden-btn');
            setButtonLoading(removeHiddenBtn, false);
            showToast('üóëÔ∏è', `Removed ${msg.count} hidden layer${msg.count !== 1 ? 's' : ''} `);
          }

          if (msg.type === 'redundant-removed') {
            setButtonLoading(document.getElementById('remove-redundant-btn'), false);
            showToast('üì¶', `Flattened ${msg.count} redundant wrappers`);
          }

          if (msg.type === 'detached-colors-found') {
            setButtonLoading(scanColorsBtn, false);
            renderDetachedColors(msg.data);
            if (msg.data && msg.data.length > 0) {
              showToast('üé®', `Found ${msg.data.length} layer${msg.data.length !== 1 ? 's' : ''} with detached colors`);
            } else {
              showToast('‚úÖ', 'No detached colors found!');
            }
          }

          if (msg.type === 'quality-audit-complete') {
            setButtonLoading(auditBtn, false);
            renderQualityAudit(msg.healthScore, msg.errors, msg.totalChecks, msg.passedChecks, msg.improvementTips);
            showToast('üõ°Ô∏è', `Health Score: ${msg.healthScore}/100`);
          }

          if (msg.type === 'status-applied') {
            setButtonLoading(applyStatusBtn, false);
            showToast('üöÄ', `Status applied to ${msg.count} frame${msg.count !== 1 ? 's' : ''}`);
          }

          if (msg.type === 'error') {
            setButtonLoading(autoRenameBtn, false);
            setButtonLoading(scanColorsBtn, false);
            setButtonLoading(auditBtn, false);
            setButtonLoading(applyStatusBtn, false);
            showToast('‚ùå', msg.message);
          }

          if (msg.type === 'node-located') {
            showToast('üéØ', `Located: ${msg.nodeName}`);
          }

          if (msg.type === 'load-preferences') {
            if (msg.tab && msg.tab !== currentTab) {
              const targetButton = document.querySelector(`[data-tab="${msg.tab}"]`);
              if (targetButton) {
                targetButton.click();
              }
            }
          }

          if (msg.type === 'region-assigned') {
            const region = msg.region; // 'header', 'body', 'footer'
            const statusEl = document.getElementById(`status-${region}`);
            const zoneEl = document.getElementById(`zone-${region}`);

            if (statusEl) statusEl.classList.remove('hidden');
            if (zoneEl) zoneEl.classList.add('assigned');

            showToast('‚úÖ', `Assigned ${region} successfully`);

            // Enable auto-structure if body is assigned
            if (region === 'body') {
              const autoBtn = document.getElementById('auto-structure-btn');
              if (autoBtn) autoBtn.disabled = false;
            }
          }

          if (msg.type === 'structure-complete') {
            setButtonLoading(document.getElementById('auto-structure-btn'), false);
            showToast('üèóÔ∏è', `Structured ${msg.count} items in Body`);
          }

          // Settings & Undo/Redo message handlers
          if (msg.type === 'settings-loaded') {
            const s = msg.settings;
            document.getElementById('setting-achievements-enabled').checked = s.achievements.enabled;
            document.getElementById('setting-threshold-first').value = s.achievements.thresholds.first;
            document.getElementById('setting-threshold-novice').value = s.achievements.thresholds.novice;
            document.getElementById('setting-threshold-expert').value = s.achievements.thresholds.expert;
            document.getElementById('setting-threshold-master').value = s.achievements.thresholds.master;
            document.getElementById('setting-default-casing').value = s.naming.defaultCasing;
            document.getElementById('setting-default-convention').value = s.naming.defaultConvention;
            document.getElementById('setting-show-advanced').checked = s.modules.showAdvancedOptions;
            document.getElementById('setting-remember-tab').checked = s.modules.rememberTab;

            // Update achievement thresholds disabled state
            const thresholdsGroup = document.getElementById('achievement-thresholds');
            if (thresholdsGroup) {
              thresholdsGroup.classList.toggle('disabled', !s.achievements.enabled);
            }
          }

          if (msg.type === 'settings-saved') {
            showToast('‚úÖ', 'Settings saved successfully');
          }

          if (msg.type === 'settings-reset') {
            showToast('üîÑ', 'Settings reset to defaults');
            // Reload settings in modal
            parent.postMessage({ pluginMessage: { type: 'load-settings' } }, '*');
          }

          if (msg.type === 'history-updated') {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            if (undoBtn) undoBtn.disabled = !msg.canUndo;
            if (redoBtn) redoBtn.disabled = !msg.canRedo;
          }

          if (msg.type === 'auto-rename-complete') {
            setButtonLoading(autoRenameBtn, false);
            showToast('‚úÖ', `Renamed ${msg.count} layer(s)`);

            // Update undo/redo buttons
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            if (undoBtn) undoBtn.disabled = !msg.canUndo;
            if (redoBtn) redoBtn.disabled = !msg.canRedo;
          }
        };

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        // ========================================
        // SETTINGS & UNDO/REDO EVENT HANDLERS
        // ========================================
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const modalClose = document.querySelector('.modal-close');
        const saveSettingsBtn = document.getElementById('settings-save-btn');
        const resetSettingsBtn = document.getElementById('settings-reset-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');

        // Open settings modal
        settingsBtn?.addEventListener('click', () => {
          settingsModal?.classList.add('show');
          parent.postMessage({ pluginMessage: { type: 'load-settings' } }, '*');
        });

        // Close settings modal
        modalClose?.addEventListener('click', () => {
          settingsModal?.classList.remove('show');
        });

        // Close on overlay click
        settingsModal?.addEventListener('click', (e) => {
          if (e.target === settingsModal) {
            settingsModal.classList.remove('show');
          }
        });

        // Save settings
        saveSettingsBtn?.addEventListener('click', () => {
          const settings = {
            achievements: {
              enabled: document.getElementById('setting-achievements-enabled') ? document.getElementById('setting-achievements-enabled').checked : true,
              thresholds: {
                first: parseInt(document.getElementById('setting-threshold-first') ? document.getElementById('setting-threshold-first').value : '1') || 1,
                novice: parseInt(document.getElementById('setting-threshold-novice') ? document.getElementById('setting-threshold-novice').value : '10') || 10,
                expert: parseInt(document.getElementById('setting-threshold-expert') ? document.getElementById('setting-threshold-expert').value : '50') || 50,
                master: parseInt(document.getElementById('setting-threshold-master') ? document.getElementById('setting-threshold-master').value : '100') || 100
              }
            },
            naming: {
              defaultCasing: document.getElementById('setting-default-casing') ? document.getElementById('setting-default-casing').value : 'pascal',
              defaultConvention: document.getElementById('setting-default-convention') ? document.getElementById('setting-default-convention').value : 'atomic'
            },
            modules: {
              showAdvancedOptions: document.getElementById('setting-show-advanced') ? document.getElementById('setting-show-advanced').checked : false,
              rememberTab: document.getElementById('setting-remember-tab') ? document.getElementById('setting-remember-tab').checked : false
            }
          };

          parent.postMessage({ pluginMessage: { type: 'save-settings', settings: settings } }, '*');
          if (settingsModal) settingsModal.classList.remove('show');
        });

        // ========================================
        // ADVANCED RENAMING - EVENT HANDLERS
        // ========================================

        // Checkbox toggles for advanced options
        var enableSequential = document.getElementById('enable-sequential');
        var sequentialControls = document.getElementById('sequential-controls');
        if (enableSequential && sequentialControls) {
          enableSequential.addEventListener('change', function () {
            sequentialControls.style.display = this.checked ? 'block' : 'none';
          });
        }

        var enableFindReplace = document.getElementById('enable-find-replace');
        var findReplaceControls = document.getElementById('find-replace-controls');
        if (enableFindReplace && findReplaceControls) {
          enableFindReplace.addEventListener('change', function () {
            findReplaceControls.style.display = this.checked ? 'block' : 'none';
          });
        }

        var enablePrefixSuffix = document.getElementById('enable-prefix-suffix');
        var prefixSuffixControls = document.getElementById('prefix-suffix-controls');
        if (enablePrefixSuffix && prefixSuffixControls) {
          enablePrefixSuffix.addEventListener('change', function () {
            prefixSuffixControls.style.display = this.checked ? 'block' : 'none';
          });
        }

        // Preview modal elements
        var previewModal = document.getElementById('preview-modal');
        var closePreview = document.getElementById('close-preview');
        var cancelPreview = document.getElementById('cancel-preview');
        var applyPreview = document.getElementById('apply-preview');
        var previewList = document.getElementById('preview-list');
        var previewCount = document.getElementById('preview-count');
        var currentPreviews = [];

        // Close preview modal handlers
        if (closePreview) {
          closePreview.addEventListener('click', function () {
            previewModal.style.display = 'none';
          });
        }

        if (cancelPreview) {
          cancelPreview.addEventListener('click', function () {
            previewModal.style.display = 'none';
          });
        }

        if (previewModal) {
          previewModal.addEventListener('click', function (e) {
            if (e.target === previewModal) {
              previewModal.style.display = 'none';
            }
          });
        }

        // Helper function to collect rename options
        function collectRenameOptions() {
          var options = {
            convention: document.getElementById('convention-select') ? document.getElementById('convention-select').value : 'semantic',
            casing: document.getElementById('casing-select') ? document.getElementById('casing-select').value : 'kebab',
            filters: {}
          };

          if (enableSequential && enableSequential.checked) {
            options.sequential = {
              enabled: true,
              start: parseInt(document.getElementById('seq-start').value) || 1,
              padding: parseInt(document.getElementById('seq-padding').value) || 2,
              position: document.getElementById('seq-position').value || 'suffix'
            };
          }

          if (enableFindReplace && enableFindReplace.checked) {
            var findText = document.getElementById('find-text').value;
            if (findText) {
              options.findReplace = {
                enabled: true,
                find: findText,
                replace: document.getElementById('replace-text').value || '',
                caseSensitive: document.getElementById('case-sensitive').checked
              };
            }
          }

          if (enablePrefixSuffix && enablePrefixSuffix.checked) {
            var prefix = document.getElementById('prefix-text').value;
            var suffix = document.getElementById('suffix-text').value;
            if (prefix || suffix) {
              options.prefixSuffix = {
                enabled: true,
                prefix: prefix || '',
                suffix: suffix || ''
              };
            }
          }

          return options;
        }

        // Preview button handler
        var previewBtn = document.getElementById('preview-rename-btn');
        if (previewBtn) {
          previewBtn.addEventListener('click', function () {
            console.log('Preview button clicked');
            var options = collectRenameOptions();
            console.log('Options:', options);
            parent.postMessage({ pluginMessage: { type: 'preview-rename', options: options } }, '*');
          });
        }

        // Apply button handler
        var applyBtn = document.getElementById('apply-rename-btn');
        if (applyBtn) {
          applyBtn.addEventListener('click', function () {
            console.log('Apply button clicked');
            var options = collectRenameOptions();
            parent.postMessage({ pluginMessage: { type: 'preview-rename', options: options } }, '*');
          });
        }

        // Apply preview handler
        if (applyPreview) {
          applyPreview.addEventListener('click', function () {
            console.log('Applying preview changes');
            if (currentPreviews.length > 0) {
              parent.postMessage({ pluginMessage: { type: 'apply-preview', changes: currentPreviews } }, '*');
              previewModal.style.display = 'none';
            }
          });
        }

        // Preset button handlers
        var presetBtns = document.querySelectorAll('.preset-btn');
        console.log('Found preset buttons:', presetBtns.length);
        for (var i = 0; i < presetBtns.length; i++) {
          presetBtns[i].addEventListener('click', function () {
            var preset = this.getAttribute('data-preset');
            console.log('Preset clicked:', preset);
            parent.postMessage({ pluginMessage: { type: 'apply-preset', preset: preset } }, '*');
          });
        }

        // Handle preview response from backend
        window.addEventListener('message', function (event) {
          var msg = event.data.pluginMessage;
          if (!msg) return;

          if (msg.type === 'rename-preview') {
            console.log('Received preview:', msg);
            if (msg.error) {
              showToast(msg.error, 'error');
              return;
            }

            currentPreviews = msg.previews;

            previewList.innerHTML = '';
            if (msg.previews.length === 0) {
              previewList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No changes to preview</p>';
            } else {
              for (var i = 0; i < msg.previews.length; i++) {
                var preview = msg.previews[i];
                var item = document.createElement('div');
                item.style.cssText = 'padding: 8px 12px; margin-bottom: 6px; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid var(--accent-primary);';
                item.innerHTML = '<div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">' + preview.oldName + '</div>' +
                  '<div style="font-size: 11px; color: var(--accent-primary); font-weight: 600;">‚Üí ' + preview.newName + '</div>';
                previewList.appendChild(item);
              }
            }

            previewCount.textContent = msg.previews.length;
            previewModal.style.display = 'flex';
          }
        });

        console.log('Advanced renaming event handlers initialized');


        // Reset settings
        resetSettingsBtn?.addEventListener('click', () => {
          if (confirm('Reset all settings to defaults?')) {
            parent.postMessage({ pluginMessage: { type: 'reset-settings' } }, '*');
          }
        });

        // Undo button
        undoBtn?.addEventListener('click', () => {
          parent.postMessage({ pluginMessage: { type: 'undo' } }, '*');
        });

        // Redo button
        redoBtn?.addEventListener('click', () => {
          parent.postMessage({ pluginMessage: { type: 'redo' } }, '*');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Cmd/Ctrl + Z = Undo
          if ((e.metaKey || e.ctrlKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            parent.postMessage({ pluginMessage: { type: 'undo' } }, '*');
          }
          // Cmd/Ctrl + Shift + Z = Redo
          if ((e.metaKey || e.ctrlKey) && e.key === 'z' && e.shiftKey) {
            e.preventDefault();
            parent.postMessage({ pluginMessage: { type: 'redo' } }, '*');
          }
        });

        // Toggle achievement thresholds based on enabled checkbox
        document.getElementById('setting-achievements-enabled')?.addEventListener('change', (e) => {
          const thresholdsGroup = document.getElementById('achievement-thresholds');
          if (thresholdsGroup) {
            thresholdsGroup.classList.toggle('disabled', !e.target.checked);
          }
        });

        // ========================================
        // INITIALIZATION
        // ========================================
        parent.postMessage({
          pluginMessage: { type: 'load-preferences' }
        }, '*');
      </script>

      <!-- Settings Modal -->
      <div id="settings-modal" class="modal-overlay" role="dialog" aria-labelledby="settings-title" aria-modal="true">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="settings-title">Settings</h2>
            <button class="modal-close" aria-label="Close settings">‚úï</button>
          </div>

          <div class="modal-body">
            <!-- Achievement Settings -->
            <section class="settings-section">
              <h3 class="settings-section-title">üèÜ Achievement Settings</h3>

              <label class="settings-toggle">
                <input type="checkbox" id="setting-achievements-enabled" checked>
                <span>Enable Easter Egg Achievements</span>
              </label>

              <div class="settings-group" id="achievement-thresholds">
                <label class="settings-label">
                  <span>First Steps (layers renamed)</span>
                  <input type="number" id="setting-threshold-first" value="1" min="1" max="100">
                </label>

                <label class="settings-label">
                  <span>Layer Novice</span>
                  <input type="number" id="setting-threshold-novice" value="10" min="1" max="100">
                </label>

                <label class="settings-label">
                  <span>Organization Expert</span>
                  <input type="number" id="setting-threshold-expert" value="50" min="1" max="200">
                </label>

                <label class="settings-label">
                  <span>Layer Master</span>
                  <input type="number" id="setting-threshold-master" value="100" min="1" max="500">
                </label>
              </div>
            </section>

            <!-- Naming Preferences -->
            <section class="settings-section">
              <h3 class="settings-section-title">üè∑Ô∏è Naming Preferences</h3>

              <label class="settings-label">
                <span>Default Casing</span>
                <select id="setting-default-casing" class="settings-select">
                  <option value="pascal">PascalCase</option>
                  <option value="kebab">kebab-case</option>
                  <option value="camel">camelCase</option>
                  <option value="snake">snake_case</option>
                </select>
              </label>

              <label class="settings-label">
                <span>Default Convention</span>
                <select id="setting-default-convention" class="settings-select">
                  <option value="atomic">Atomic Design</option>
                  <option value="slash">Slash Structure</option>
                  <option value="bem">BEM Style</option>
                  <option value="architect">Architect Mode</option>
                </select>
              </label>
            </section>

            <!-- Module Defaults -->
            <section class="settings-section">
              <h3 class="settings-section-title">‚öôÔ∏è Module Defaults</h3>

              <label class="settings-toggle">
                <input type="checkbox" id="setting-show-advanced">
                <span>Show Advanced Options by Default</span>
              </label>

              <label class="settings-toggle">
                <input type="checkbox" id="setting-remember-tab">
                <span>Remember Last Active Tab</span>
              </label>
            </section>
          </div>

          <div class="modal-footer">
            <button id="settings-reset-btn" class="btn btn-secondary">Reset to Defaults</button>
            <button id="settings-save-btn" class="btn btn-primary">Save Settings</button>
          </div>
        </div>
      </div>

</body>


</html>